#!/usr/bin/groovy

@Library('test-shared-library') _

def dockerImage

def setPrismaScanningStages(assemblyType, stageIndex) {
    def assemblyImage
    stage("${stageIndex}.A. Scan ${assemblyType} jar using Prisma") {
        script {
            branchName = "${env.BRANCH_NAME}".replace('/', '-')
            assemblyImage = "h2o-assemblies/${assemblyType}:${BUILD_NUMBER}-${branchName}"

            sh "docker build . -t ${assemblyImage} -f ./docker/prisma/Dockerfile.${assemblyType}jars"

            // scan the image
            prismaCloudScanImage ca: '',
                    cert: '',
                    dockerAddress: 'unix:///var/run/docker.sock',
                    image: "${assemblyImage}",
                    key: '',
                    logLevel: 'info',
                    podmanPath: '',
                    project: '',
                    resultsFile: "prisma-${assemblyType}-scan-results.json",
                    ignoreImageBuildTime: true
        }
    }
    stage("${stageIndex}.B. Export results for ${assemblyType} jar to CSV") {
        withCredentials([usernamePassword(credentialsId: 'twistlock_credentials', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD')]) {
            sh "curl -k -u \$USERNAME:\$PASSWORD https://mr-0xz1:8083/api/v1/scans/download?search=${assemblyImage} > ${assemblyImage}.csv"
        }
        archiveArtifacts artifacts: "${assemblyImage}.csv"
    }
    stage("${stageIndex}.C. Publish report for ${assemblyType} jar") {
        prismaCloudPublish resultsFilePattern: "prisma-${assemblyType}-scan-results.json"
    }
}

def runSnykTest(assemblyType) {
    withCredentials([string(credentialsId: 'H2O_3_SNYK_TOKEN_JENKINS', variable: 'SNYK_TOKEN')]) {
        sh "snyk container test snyk-troubleshoot --file=./docker/prisma/Dockerfile.${assemblyType}jars --json-file-output=snyk-${assemblyType}.json --severity-threshold=medium --app-vulns --nested-jars-depth=4"
    }
}

pipeline {
    agent { node { label 'linux&&docker' } }

    options {
        ansiColor('xterm')
        timestamps()
    }

    stages {
        stage('0. Init'){
            steps{
                script{
                    dir("docker/prisma"){
                        dockerImage = docker.build("node-java","-f Dockerfile .")
                    }
                }
                
            }
        }
        stage('1. Build jars') {
            steps {
                script{
                    dockerImage.inside(){
                        sh "./gradlew :h2o-assemblies:steam:shadowJar"
                        sh "./gradlew :h2o-assemblies:main:shadowJar"
                        archiveArtifacts artifacts: "h2o-assemblies/steam/build/libs/*.jar"
                        archiveArtifacts artifacts: "h2o-assemblies/main/build/libs/*.jar"
                    }
                }
            }
        }
//        stage('2. Steam assembly jar (Prisma)') {
//            steps {
//                setPrismaScanningStages("steam", 2)
//            }
//        }
//        stage('3. Main assembly jar (Prisma)') {
//            steps {
//                setPrismaScanningStages("main", 3)
//            }
//        }
        stage('4. Steam assembly jar (Snyk)') {
            steps {
                script {
                    dockerImage.inside() {
                        runSnykTest("steam")
                    }
                }
            }
        }
        stage('5. Main assembly jar (Snyk)') {
            steps {
                script {
                    dockerImage.inside() {
                        runSnykTest("main")
                    }
                }
            }
        }
    }
    post {
      always {
        cleanWs()
      }
    }
}
